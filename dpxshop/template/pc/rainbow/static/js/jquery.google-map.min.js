(function(b){var a=0;var c=function(e,d){this.element=e,this.defaults={lat:"22.444531",lng:"113.433033",coordinates:"",coordinates_name:"coordinates",lat_name:"gcj_lat",lng_name:"gcj_lng",minLength:"2",key:"AIzaSyBtexRsEikrIIUPZg5BslMEjNfrc750peU",google_url:"www.google.cn/maps/api/js?sensor=false&libraries=drawing",height:"800px",callback:null,data:{}},this.options=b.extend({},this.defaults,d)};c.prototype={myMap:null,bermudaTriangle:null,myDrawingManager:null,myField:null,triangleCoords:null,myInfoWindow:null,centerpoint:null,modal:null,lat_input:null,lng_input:null,coordinates_input:null,address_input:null,modal_tpl:'<div class="modal fade text-center"><div class="modal-dialog" style="display: inline-block; width:90%;"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title" id="title_id">地图标注</h4></div><div class="modal-body"><div class=" row"><div class="col-md-4 col-xs-9"><div class="input-group"><input class="form-control  _google_address" type="text"  placeholder="地址搜索"><span class="input-group-btn"><button type="button" class="_clearPolygon btn btn-sm btn-info no-radius">绘制形状</button></span></div> </div></div><div class="row"><div class="col-md-12 col-xs-12"><div class="_map_canvas" ></div></div></div></div></div></div></div> ',create:function(){var d=this;this.element.click(function(){d.buildMap()})},buildMap:function(){var f=this;f.getParam();var g=f.options;f.addCss();if(typeof google=="undefined"){var d="modalGoogleMapInit"+(new Date()).getTime();window[d]=function(){delete window.modalGoogleMapInitFuncName;f.buildMap()};var e=document.createElement("script");e.type="text/javascript";e.src="http://"+g.google_url+"&key="+g.key+"&callback="+d;document.body.appendChild(e)}else{f.modal=b(f.modal_tpl).modal("show");f.initialize();f.autocomplete()}},getParam:function(){var l=this,m=l.options;var e=b(this.element);var h=e.data("lat-name");if(h){m.lat_name=h}l.lat_input=b("input[name='"+m.lat_name+"']");var f=l.lat_input.val();if(f){m.lat=f}var g=e.data("lng-name");if(g){m.lng_name=g}l.lng_input=b("input[name='"+m.lng_name+"']");var i=l.lng_input.val();if(i){m.lng=i}var d=e.data("coordinates-name");if(d){m.coordinates_name=d}l.coordinates_input=b("input[name='"+m.coordinates_name+"']");var k=l.coordinates_input.val();if(k){m.coordinates=Main.Txt2Points(k,"google")}var j=e.data("address");if(j){m.address=j}return false},addCss:function(){var d=this;var g=document.createElement("style");g.type="text/css";var f="._map_canvas { height: "+d.options.height+"; } .ui-autocomplete {  z-index: 1051 !important; }";g.appendChild(document.createTextNode(f));var e=document.getElementsByTagName("head")[0];e.appendChild(g)},initialize:function(){var d=this,f=d.options;d.centerpoint=new google.maps.LatLng(f.lat,f.lng);var e={zoom:16,center:d.centerpoint,mapTypeId:google.maps.MapTypeId.HYBRID};d.myMap=new google.maps.Map(b("._map_canvas",d.modal).get(0),e);d.myInfoWindow=new google.maps.InfoWindow();d.DrawingTools();google.maps.event.addListenerOnce(d.myMap,"idle",function(){google.maps.event.trigger(d.myMap,"resize");var g=new google.maps.LatLng(f.lat,f.lng);d.myMap.setCenter(g)});google.maps.event.addDomListener(d.myInfoWindow,"domready",function(){b("._googleMapEdit").click(function(){d.PolygonEditable(true)});b("._googleMapFinish").click(function(){d.finish(d.myField)});b("._googleMapAdd").click(function(){d.DeleteField(d.myField)})});b("._clearPolygon",d.modal).click(function(){d.myInfoWindow.close();d.myField.setMap(null);d.ShowDrawingTools(true)})},getPaths:function(){var d=this,e=d.options;d.triangleCoords=[];b.each(e.coordinates,function(g,f){if(typeof(f.lng)!="undefined"&&typeof(f.lat)!="undefined"){d.triangleCoords[g]=new google.maps.LatLng(f.lat,f.lng)}});return false},showPolygon:function(){var d=this,e=d.options;d.getPaths();if(d.triangleCoords.length>0){d.bermudaTriangle=new google.maps.Polygon({paths:d.triangleCoords,strokeColor:"red",fillColor:"#FF0000",fillOpacity:0});d.bermudaTriangle.setMap(d.myMap);d.ShowDrawingTools(false);d.myField=d.bermudaTriangle;google.maps.event.addListener(d.bermudaTriangle,"click",function(g){var f=d.GetMessage(d.bermudaTriangle);d.myInfoWindow.setOptions({content:f});d.myInfoWindow.setPosition(g.latLng);d.myInfoWindow.open(d.myMap)})}return false},DrawingTools:function(){var d=this,e=d.options;d.myDrawingManager=new google.maps.drawing.DrawingManager({drawingMode:null,drawingControl:true,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.POLYGON]},polygonOptions:{draggable:true,editable:true,strokeColor:"red",fillColor:"#FF0000",fillOpacity:0}});d.myDrawingManager.setMap(d.myMap);d.showPolygon();d.FieldDrawingCompletionListener()},FieldDrawingCompletionListener:function(){var d=this;google.maps.event.addListener(d.myDrawingManager,"polygoncomplete",function(f){d.myField=f;d.ShowDrawingTools(false);d.PolygonEditable(false);var g=d.GetMessage(d.myField);d.myInfoWindow.setOptions({content:g});var e=d.getPolygonCenter(f);d.myInfoWindow.setPosition(e);d.myInfoWindow.open(d.myMap);d.FieldClickListener()})},ShowDrawingTools:function(e){var d=this;d.myDrawingManager.setOptions({drawingMode:null,drawingControl:e})},PolygonEditable:function(e){var d=this;d.myField.setOptions({editable:e,draggable:e});d.myInfoWindow.close();return false},FieldClickListener:function(){var d=this;google.maps.event.addListener(d.myField,"click",function(f){var e=d.GetMessage(d.myField);d.myInfoWindow.setOptions({content:e});d.myInfoWindow.setPosition(f.latLng);d.myInfoWindow.open(d.myMap)})},DeleteField:function(){var d=this;d.myInfoWindow.close();d.myField.setMap(null);d.ShowDrawingTools(true);d.clearOutput()},GetMessage:function(f){var e=this;var j=f.getPath();var i=j.getArray();var d=parseFloat(google.maps.geometry.spherical.computeArea(j))*3/2000;var h=d.toFixed(4);var g="";g+='<div style="color:#000">已选择 '+i.length+" 个坐标<br>面积约 "+h+" 亩</div>";g+='<p><button type="button"  class="btn btn-info btn-sm _googleMapEdit"   >编辑</button> <button type="button"  class="btn btn-info btn-sm _googleMapFinish">完成</button> <button type="button"  class="btn btn-info btn-sm _googleMapAdd">重选</button></p>';return g},GetArea:function(e){var f=e.getPath();var d=parseFloat(google.maps.geometry.spherical.computeArea(f))*3/2000;return d.toFixed(2)},finish:function(e){var d=this;d.setPolygonCoordinates(e);d.setPolygonCenter(e);d.myField.setOptions({editable:false,draggable:false});d.element.text("已标注");d.myInfoWindow.close();d.modal.modal("hide");if(d.options.callback&&typeof(d.options.callback)==="function"){d.options.callback.call(d)}return false},setPolygonCoordinates:function(f){var d=this;var h=f.getPath().getArray();var g="";for(var e=0;e<h.length;e++){g+=h[e].lat()+","+h[e].lng()+";"}d.coordinates_input.val(g);return g},getPolygonCenter:function(f){var d=this;var h=f.getPath().getArray();var g=new google.maps.LatLngBounds();var e;for(e=0;e<h.length;e++){g.extend(h[e])}return g.getCenter()},setPolygonCenter:function(f){var e=this;var d=e.getPolygonCenter(f);e.lat_input.val(d.lat());e.lng_input.val(d.lng());return d},clearOutput:function(){var d=this;d.lat_input.val("");d.lng_input.val("");d.coordinates_input.val("")},autocomplete:function(){var d=this,e=d.options;d.address_input=b("._google_address",d.modal);if(e.address){d.address_input.val(e.address+" ")}b("._google_address",d.modal).autocomplete({source:function(h,g){var f=d.address_input.val();geocoder=new google.maps.Geocoder();geocoder.geocode({address:f},function(j,i){if(i==google.maps.GeocoderStatus.OK){g(b.map(j,function(k){var l=k.formatted_address.replace("中国","");return{label:l,value:l,lat:k.geometry.location.lat(),lng:k.geometry.location.lng()}}))}})},delay:200,minLength:d.options.minLength,select:function(f,g){e.lat=g.item.lat;e.lng=g.item.lng;d.initialize();d.ShowDrawingTools(true)}})}};b.fn.googleMap=function(d){var e=new c(this,d);e.create()}})(jQuery);